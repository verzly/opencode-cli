name: Repackage OpenCode Windows Executables

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.1.13)'
        required: true
        default: 'latest'
        type: string

jobs:
  repackage:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download and repackage executables
        id: repackage
        run: |
          mkdir -p downloads output
          
          VERSION="${{ github.event.inputs.version }}"
          REPO_URL="https://github.com/anomalyco/opencode/releases/download"
          
          # ZIP files configuration
          # Format: zip_filename:path_in_zip:output_filename
          ZIPS=(
            "opencode-windows-x64-baseline.zip:opencode.exe:opencode-baseline.exe"
            "opencode-windows-x64.zip:opencode.exe:opencode.exe"
          )
          
          # Download and extract
          echo "Downloading from version: $VERSION"
          for config in "${ZIPS[@]}"; do
            IFS=':' read -r zip_name path_in_zip output_name <<< "$config"
            
            DOWNLOAD_URL="$REPO_URL/$VERSION/$zip_name"
            
            echo "Downloading: $zip_name from $DOWNLOAD_URL"
            curl -L -f -o "downloads/$zip_name" "$DOWNLOAD_URL" || {
              echo "❌ Failed to download: $zip_name"
              exit 1
            }
            
            # Extract
            echo "Extracting: $zip_name"
            unzip -q "downloads/$zip_name" -d "downloads/$zip_name.extracted"
            
            # Debug: show available exe files
            echo "Available files in $zip_name:"
            find "downloads/$zip_name.extracted/" -type f \( -name "*.exe" -o -name "opencode*" \) | head -20
            
            # Find and copy file
            if [ -f "downloads/$zip_name.extracted/$path_in_zip" ]; then
              cp "downloads/$zip_name.extracted/$path_in_zip" "output/$output_name"
              echo "✓ $zip_name -> $output_name"
            else
              echo "❌ Path not found: $path_in_zip in $zip_name"
              exit 1
            fi
          done
          
          echo "Final output:"
          ls -lah output/
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.version }}
          files: output/*
          body: "These executables were automatically repackaged from OpenCode [${{ github.event.inputs.version }}](https://github.com/anomalyco/opencode/releases/tag/${{ github.event.inputs.version }})."
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Clean up
        if: always()
        run: |
          rm -rf downloads output