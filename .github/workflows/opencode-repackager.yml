name: Repackage OpenCode Windows Executables

on:
  schedule:
    # Runs daily at 2:00 AM UTC
    - cron: '0 2 * * *'
  
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.1.13), or leave empty for latest'
        required: false
        type: string

jobs:
  repackage:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Get latest version if not specified
        id: get_version
        run: |
          if [ -z "${{ github.event.inputs.version }}" ]; then
            echo "Fetching latest version..."
            VERSION=$(curl -s "https://api.github.com/repos/anomalyco/opencode/releases/latest" | jq -r '.tag_name')
            echo "Found latest version: $VERSION"
          else
            VERSION="${{ github.event.inputs.version }}"
            echo "Using specified version: $VERSION"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Check if version already exists
        id: check_version
        run: |
          VERSION_EXISTS=$(curl -s "https://api.github.com/repos/${{ github.repository_owner }}/opencode-cli/releases/tags/${{ steps.get_version.outputs.version }}" | jq -r '.tag_name // "NOT_FOUND"')
          
          if [ "$VERSION_EXISTS" = "NOT_FOUND" ]; then
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Version does not exist locally, proceeding..."
          else
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Version already exists locally, skipping."
          fi
      
      - name: Download and repackage executables
        if: steps.check_version.outputs.exists == 'false'
        id: repackage
        run: |
          mkdir -p downloads output
          
          VERSION="${{ steps.get_version.outputs.version }}"
          REPO_URL="https://github.com/anomalyco/opencode/releases/download"
          
          # ZIP files configuration
          # Format: zip_filename:path_in_zip:output_filename
          ZIPS=(
            "opencode-windows-x64-baseline.zip:opencode.exe:opencode-baseline.exe"
            "opencode-windows-x64.zip:opencode.exe:opencode.exe"
          )
          
          # Download and extract
          echo "Downloading from version: $VERSION"
          for config in "${ZIPS[@]}"; do
            IFS=':' read -r zip_name path_in_zip output_name <<< "$config"
            
            DOWNLOAD_URL="$REPO_URL/$VERSION/$zip_name"
            
            echo "Downloading: $zip_name from $DOWNLOAD_URL"
            curl -L -f -o "downloads/$zip_name" "$DOWNLOAD_URL" || {
              echo "❌ Failed to download: $zip_name"
              exit 1
            }
            
            # Extract
            echo "Extracting: $zip_name"
            unzip -q "downloads/$zip_name" -d "downloads/$zip_name.extracted"
            
            # Debug: show available exe files
            echo "Available files in $zip_name:"
            find "downloads/$zip_name.extracted/" -type f \( -name "*.exe" -o -name "opencode*" \) | head -20
            
            # Find and copy file
            if [ -f "downloads/$zip_name.extracted/$path_in_zip" ]; then
              cp "downloads/$zip_name.extracted/$path_in_zip" "output/$output_name"
              echo "✓ $zip_name -> $output_name"
            else
              echo "❌ Path not found: $path_in_zip in $zip_name"
              exit 1
            fi
          done
          
          echo "Final output:"
          ls -lah output/
      
      - name: Create Release
        if: steps.check_version.outputs.exists == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          files: output/*
          body: "These executables were automatically repackaged from OpenCode [${{ steps.get_version.outputs.version }}](https://github.com/anomalyco/opencode/releases/tag/${{ steps.get_version.outputs.version }})."
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Clean up
        if: always()
        run: |
          rm -rf downloads output